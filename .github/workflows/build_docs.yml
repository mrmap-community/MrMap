name: build docs
on:
  workflow_dispatch:
  pull_request:
    branches: [master, develop]
    types: [opened, synchronize, reopened]

jobs:
  check-docs:
    name: build docs
    runs-on: ubuntu-20.04
    steps:
      - name: source branch name
        run: echo ${{ github.head_ref }}
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}
      # Install all system dependencies for the MrMap project
      # ===============================
      - name: Install System Dependencies for MrMap project
        run: |
          sudo apt-get update && sudo apt-get install -y --no-install-recommends \
          libssl-dev \
          libcurl4-openssl-dev \
          gdal-bin \
      # Install sphinx local
      # ===============================
      - name: Install sphinx
        run: |
          sudo apt-get install python3-sphinx
      # Upgrade pip, setuptools and wheel
      # ===============================
      - name: Upgrade pip, setuptools and wheel
        run: python -m pip install --upgrade pip setuptools wheel
      - name: Install pip dependencies
        run: |
            pip3 install -r ./backend/requirements.txt && pip3 install -r ./docs/requirements.txt
      # ===============================
      # Build documentation
      # ===============================
      - name: build documentation
        run: |
          export $(grep -v '^#' ./docs/.docs.env | xargs)
          MRMAP_MEDIA_DIR=./tmp sphinx-multiversion docs/source docs/build/html -b linkcheck -D smv_branch_whitelist='${{ github.head_ref }}'
          MRMAP_MEDIA_DIR=./tmp sphinx-multiversion docs/source docs/build/html -b html -E -D smv_branch_whitelist='${{ github.head_ref }}'
      # ===============================
