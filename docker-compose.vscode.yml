# docker compose file for development with visual studio code
version: "3.8"
services:

  backend:
    command: >
      /bin/bash -c "python -u -m debugpy --listen 0.0.0.0:5678
      /opt/mrmap/manage.py makemigrations users registry object_permissions
      jobs"
    ports:
      - "0.0.0.0:3001:5678"

  celery-default-worker:
    command: >
      /bin/bash -c "python -u -m debugpy --listen 0.0.0.0:5678
      /usr/local/bin/watchmedo auto-restart --directory=./ --pattern=*.py
      --recursive -- celery -A MrMap worker -E -l DEBUG -n default -Q default"
    environment:
      PYDEVD_LOAD_VALUES_ASYNC: "True"
      PYTHONUNBUFFERED: "1"
      IPYTHONENABLE: "True"
    ports:
      - "0.0.0.0:3002:5678"

  celery-download-worker:
    command: >
      /bin/bash -c "python -u -m debugpy --listen 0.0.0.0:5678
      /usr/local/bin/watchmedo auto-restart --directory=./ --pattern=*.py
      --recursive -- celery -A MrMap worker -E -l DEBUG -n download -Q
      download_iso_metadata,download_described_elements,harvest"
    environment:
      PYDEVD_LOAD_VALUES_ASYNC: "True"
      PYTHONUNBUFFERED: "1"
      IPYTHONENABLE: "True"
    ports:
      - "0.0.0.0:3003:5678"

  behave:
    command: >
      /bin/bash -c "python -u -m debugpy --listen 0.0.0.0:5678
      /opt/mrmap/manage.py behave --noinput --tags=-skip --no-skipped
      tests/behave/api/features && python -u -m debugpy --listen 0.0.0.0:5678
      /opt/mrmap/manage.py behave --noinput --tags=-skip --no-skipped
      tests/behave/selenium/features"
    ports:
      - "0.0.0.0:3004:5678"
