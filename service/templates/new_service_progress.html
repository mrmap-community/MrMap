{% load i18n static %}
<style>

    .field-label, .field{
        font-size: 1.2em;
    }

    .field input{
        color: gray;
        background-color: white;
        border: 1px solid gray;
        border-radius: 0.25rem;
        padding: 0.375rem 0.75rem;
    }

    .field input:focus{
        -webkit-box-shadow: 0 0 10px var(--primary-color);
        -moz-box-shadow: 0 0 10px var(--primary-color);
        box-shadow: 0 0 10px var(--primary-color);
    }

    .form-submit-area{
        padding: 20px 0;
    }


    #capabilities-uri{
        width: 100%;
        box-sizing: border-box;
        -moz-box-sizing: border-box;
        -webkit-box-sizing: border-box;
    }

    .form-table{
        font-size: 0.9em !important;
        color: black;
    }
    .form-table tbody{
        border: 1px solid var(--primary-color-light);
        border-radius: 10px;
        padding: 10px;
    }
    .form-table td{

    }

    .loading-spinner{
        border: none;
        color: white;
        padding: 0 10px 0 0;
    }

    .submit-button{
        margin: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--secondary-color);
        float: right;
    }

    .submit-button:hover{
        background-color: var(--secondary-color-light);
    }

    .form-advice{
        display: flex;
        align-items: center;
        justify-content: space-evenly;
        background-color: var(--secondary-color);
        padding: 10px;
        margin: 10px 0 10px 0;
    }

    .form-advice span{
        text-align: justify;
        color: white;
        font-weight: bold;
        max-width: 60vw;
    }
    .form-advice img{
    }

    .modal-content{
        max-height: 75vh;
        overflow-y: auto;
    }

    .progress-bar-wrapper{
        height: 1rem;
        position: relative;
    }

    .progress-bar{
        width: 100%;
        height: 1rem;
        position: absolute;
        top: 0;
    }

    .bg{
        background-color: var(--primary-color);
        opacity: 0.5;
    }

    .fg{
        background-color: var(--secondary-color);
        width: 1%;
    }
    .progress-bar.number{
        color: white;
        font-size: 0.8em;
        text-align: center;
    }
</style>

{% block body %}
<div class="modal-dialog">
    <div class="modal-close" title="{% trans 'Close' %}">
        x
    </div>
    <div class="modal-content">
        <h2>{% trans 'Registration ongoing' %}</h2>
        <article>
            {% trans 'Your service is currently processed. Please be patient!' %}
        </article>
        <article>
            '<span id="pending-service" data-id="{{ pending_task.task_id }}">{{ url_dict.service }}</span>'
            <span>{% trans 'in phase:' %}</span>
            <span id="phase"></span>
        </article>
        <div class="progress-bar-wrapper">
            <div class="progress-bar bg"></div>
            <div class="progress-bar fg"></div>
            <div class="progress-bar number"></div>
        </div>
        <button class="submit-button button">
            <span class="loading-spinner">
                <i class="fas fa-circle-notch fa-spin"></i>
            </span>
            <span id="button-text" class="hide">{% trans 'Finish' %}</span>
        </button>
    </div>
</div>

<script>

    {% include 'modal-dialog-scripts.html' %}

    $(".submit-button").click(function(){
        toggleOverlay("");
        location.reload();
    });

    $(document).ready(function(){
        sessionStorage.setItem("reloadOnClose", true);
        // run delayed requests for task progress
        var interval = setInterval(function(){
            var taskId = $("#pending-service").attr("data-id");
            $.ajax({
                url: rootUrl + "/structure/task/",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken")
                },
                data:{
                    "id": taskId,
                },
                type: 'get',
                dataType: 'json',
            })
            .done(function(data){
                var task = data["task"];
                var progress = task["info"];
                var description = JSON.parse(task["description"]);

                // set phase and service name
                if(description.service.length > 0){
                    $("#pending-service").html(description.service);
                }
                if(description.phase.length > 0){
                    $("#phase").html(description.phase);
                }

                if(progress != null){
                    progress = progress["current"];

                    // write new progress to bar
                    var pgNum = parseFloat(progress).toFixed(2) + "%";
                    $(".fg").css("width", progress + "%");
                    $(".number").html(pgNum)

                    if(progress == 100){
                        // we are done!
                        clearInterval(interval);
                        $(".loading-spinner").hide();
                        $("#button-text").show();
                    }
                }
            })
            .always(function(data){

            });
        }, 1000);
    });

</script>

{% endblock %}